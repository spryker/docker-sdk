#!/bin/sh
{% set envVariables = ["\$ALLOWED_IP", "\$SPRYKER_BUILD_HASH", "\$SPRYKER_MAINTENANCE_MODE_ENABLED"] %}
{% set exportedVars = [] %}
{% for groupData in groups %}
{% for applicationName, applicationData in groupData['applications'] %}
{% if applicationData['application'] != 'static' %}
{% for endpoint, endpointData in applicationData['endpoints'] %}
{% set identifier = endpointData['identifier'] | default(endpointData['store'] | default(endpointData['region'] | default(''))) | upper %}
{% set cgiVarName = "SPRYKER_NGINX_CGI_" ~ (applicationName | upper) ~ (identifier ? "_" ~ identifier : "") %}
{% if cgiVarName not in exportedVars %}
{% set exportedVars = exportedVars | merge([cgiVarName]) %}
{% set envVariables = envVariables | merge(["\$" ~ cgiVarName]) %}
export {{ cgiVarName }}=${{ '{' }}{{ cgiVarName }}:-${{ '{' }}SPRYKER_NGINX_CGI_HOST_{{ applicationName | upper }}{{ identifier ? "_" ~ identifier : "" }}{{ '}' }}{{ '}' }}
{% endif %}
{% endfor %}
{% endif %}
{% endfor %}
{% endfor %}

envsubst '{{ envVariables | join(' ') }}' < /etc/nginx/template/default.conf.tmpl > /etc/nginx/conf.d/default.conf

if [ -z "${SPRYKER_DNS_RESOLVER_IP}" ]; then
    export SPRYKER_DNS_RESOLVER_IP=$(grep "^\s*nameserver " /etc/resolv.conf | awk '{print $2}')
fi

envsubst '$SPRYKER_DNS_RESOLVER_IP ${SPRYKER_DNS_RESOLVER_FLAGS} {{ envVariables | join(' ') }}' < /etc/nginx/template/resolver.conf.tmpl > /etc/nginx/conf.d/00-resolver.conf

if [ -n "${SPRYKER_XDEBUG_MODE_ENABLE}" ]; then
envsubst '{{ envVariables | join(' ') }}' < /etc/nginx/template/debug.default.conf > /etc/nginx/conf.d/debug.default.conf
fi

# Execute the CMD (nginx -g "daemon off;")
exec "$@"
