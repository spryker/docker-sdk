locals {
  spryker_environment = {
{% if project['_applicationGroups'] is defined and (project['_applicationGroups'] | length > 0) %}
{# Generate grouped applications when application-group is defined
   Use main application name instead of group name (e.g., yves_eu instead of frontend_group_eu) #}
{% for groupName, groupData in project['_applicationGroups'] %}
{% if groupData['mainApplicationName'] is defined %}
    {{ groupData['mainApplicationName'] | lower | replace({'-': '_'}) }} = {
{% set mainApplicationKey = groupData['applications'] | keys | first %}
{% set mainApplicationData = groupData['applications'][mainApplicationKey] %}
{% include "terraform/application/" ~ (groupData['groupType'] | lower) ~ ".tf.twig" with {
    applicationName: (groupData['mainApplicationName'] | lower | replace({'-': '_'})),
    applicationData: mainApplicationData,
    regionName: groupData['region'],
    regionData: project.regions[groupData['region']],
    project: project,
    groupData: groupData,
    brokerConnections: brokerConnections
} %}
    }
{% endif %}
{% endfor %}
{# Also generate individual applications that are not in any group #}
{% for groupName, groupData in project.groups %}
{% for applicationName, applicationData in groupData['applications'] %}
{% if applicationData['application'] != 'static' and (project['_groupedApplications'][applicationName] is not defined) %}
    {{ applicationName | lower | replace({'-': '_'}) }} = {
{% include "terraform/application/" ~ (applicationData['application'] | lower) ~ ".tf.twig" with {
    applicationName: applicationName,
    applicationData: applicationData,
    regionName: groupData['region'],
    regionData: project.regions[groupData['region']],
    project: project
} %}
    }
{% endif %}
{% endfor %}
{% endfor %}
{% else %}
{# Fallback: Generate individual applications when no groups are defined #}
{% for groupName, groupData in project.groups %}
{% for applicationName, applicationData in groupData['applications'] %}
{% if applicationData['application'] != 'static' %}
    {{ applicationName | lower | replace({'-': '_'}) }} = {
{% include "terraform/application/" ~ (applicationData['application'] | lower) ~ ".tf.twig" with {
    applicationName: applicationName,
    applicationData: applicationData,
    regionName: groupData['region'],
    regionData: project.regions[groupData['region']],
    project: project
} %}
    }
{% endif %}
{% endfor %}
{% endfor %}
{% endif %}
    e2e = {
{% include  "terraform/e2e/e2e.tf.twig" with _context %}
    }
  }
}
