  {{ serviceName }}:
    image: mariadb:10.4
{% if serviceData['slave-services'] is defined %}
    command: --server-id=1 --log-bin=master-bin --binlog-format=mixed --init-file=/etc/mysql/mysql.conf.d/replica.sql
{% endif %}
    networks:
      - private
    labels:
      'spryker.app.name': database
      'spryker.app.type': services
      'spryker.project': ${SPRYKER_DOCKER_PREFIX}:${SPRYKER_DOCKER_TAG}
    healthcheck:
      test: ["CMD", "mysqladmin", "ping", "--silent"]
      interval: 10s
      timeout: 10s
      retries: 5
    environment:
      MYSQL_ROOT_PASSWORD: "{{ serviceData['root']['password'] }}"
      LANG: C.UTF-8
    volumes:
      - {{ serviceName }}-{{ serviceData['engine'] }}-data:/var/lib/mysql:rw
      - ./${DEPLOYMENT_PATH}/context/mysql/my.cnf:/etc/mysql/mariadb.conf.d/my.cnf:ro
      - ./${DEPLOYMENT_PATH}/context/mysql/replica.sql:/etc/mysql/mariadb.conf.d/replica.sql:ro

{% if serviceData['slave-services'] is defined %}
{% for i, slave in serviceData['slave-services'] %}
  {{ serviceName }}_{{ slave }}:
    image: mariadb:10.4
    command: --server-id={{ i+2 }} --log-bin=slave-bin --binlog-format=mixed --log-slave-updates=on --init-file=/etc/mysql/mysql.conf.d/init.sql --read-only
    networks:
        - private
    labels:
        'spryker.app.name': database_{{ slave }}
        'spryker.app.type': services
        'spryker.project': ${SPRYKER_DOCKER_PREFIX}:${SPRYKER_DOCKER_TAG}
    healthcheck:
        test: ["CMD", "mysqladmin", "ping", "--silent"]
        interval: 10s
        timeout: 10s
        retries: 5
    environment:
        MYSQL_ROOT_PASSWORD: "{{ serviceData['root']['password'] }}"
        LANG: C.UTF-8
    volumes:
        - {{ serviceName }}-{{ serviceData['engine'] }}-data:/var/lib/mysql_shared:rw
        - {{ serviceName }}-{{ slave }}-{{ serviceData['engine'] }}-data:/var/lib/mysql:rw
        - ./${DEPLOYMENT_PATH}/context/mysql_replica/my.cnf:/etc/mysql/mysql.conf.d/my.cnf:ro
        - ./${DEPLOYMENT_PATH}/context/mysql_replica/init.sql:/etc/mysql/mysql.conf.d/init.sql:ro

{% endfor %}
{% endif %}
